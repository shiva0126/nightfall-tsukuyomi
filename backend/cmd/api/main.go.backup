package main

import (
	"log"
	"fmt"
	"github.com/gin-gonic/gin"
	"github.com/shiva0126/nightfall-tsukuyomi/backend/internal/config"
	"github.com/shiva0126/nightfall-tsukuyomi/backend/internal/database"
	"github.com/shiva0126/nightfall-tsukuyomi/backend/internal/models"
	"github.com/shiva0126/nightfall-tsukuyomi/backend/internal/handlers"
)

func main() {
	cfg, err := config.Load("../../config.yaml")
	if err != nil {
		log.Printf("âš ï¸  Warning: Could not load config.yaml, using defaults: %v", err)
		cfg = &config.Config{
			Server: config.ServerConfig{Port: 8888, Host: "0.0.0.0"},
			Database: config.DatabaseConfig{
				Host: "localhost", Port: 5433, Database: "nightfall",
				User: "nightfall", Password: "nightfall_dev_2025",
			},
		}
	}

	err = database.ConnectPostgres(
		cfg.Database.Host, cfg.Database.Port,
		cfg.Database.User, cfg.Database.Password, cfg.Database.Database,
	)
	if err != nil {
		log.Fatal("Failed to connect to database:", err)
	}

	gin.SetMode(gin.DebugMode)
	router := gin.Default()

	router.Use(func(c *gin.Context) {
		c.Writer.Header().Set("Access-Control-Allow-Origin", "*")
		c.Writer.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
		c.Writer.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization")
		if c.Request.Method == "OPTIONS" {
			c.AbortWithStatus(204)
			return
		}
		c.Next()
	})

	router.GET("/health", func(c *gin.Context) {
		c.JSON(200, gin.H{
			"status": "healthy", "service": "nightfall-tsukuyomi",
			"version": "1.0.0", "database": "connected",
		})
	})

	v1 := router.Group("/api/v1")
	{
		// Scans
		v1.GET("/scans", listScans)
		v1.POST("/scans", createScan)
		v1.GET("/scans/:id", getScan)
		v1.PUT("/scans/:id/status", handlers.UpdateScanStatus)
		
		// Targets
		v1.GET("/targets", listTargets)
		v1.POST("/targets", createTarget)
		
		// Findings
		v1.POST("/findings", handlers.CreateFinding)
		v1.GET("/scans/:id/findings", getScanFindings)
	}

	addr := fmt.Sprintf("%s:%d", cfg.Server.Host, cfg.Server.Port)
	log.Printf("ðŸŒ™ Nightfall Tsukuyomi API starting on %s", addr)
	if err := router.Run(addr); err != nil {
		log.Fatal("Failed to start server:", err)
	}
}

func listScans(c *gin.Context) {
	var scans []models.Scan
	database.DB.Order("id desc").Find(&scans)
	c.JSON(200, gin.H{"scans": scans, "count": len(scans)})
}

func createScan(c *gin.Context) {
	var req struct {
		TargetID uint   `json:"target_id"`
		Domain   string `json:"domain"`
	}
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(400, gin.H{"error": err.Error()})
		return
	}

	var target models.Target
	if req.TargetID > 0 {
		database.DB.First(&target, req.TargetID)
	} else if req.Domain != "" {
		database.DB.FirstOrCreate(&target, models.Target{Domain: req.Domain})
	} else {
		c.JSON(400, gin.H{"error": "target_id or domain required"})
		return
	}

	scan := models.Scan{TargetID: target.ID, Status: "pending", RiskScore: 0}
	database.DB.Create(&scan)

	c.JSON(201, gin.H{
		"id": scan.ID, "target_id": target.ID,
		"domain": target.Domain, "status": scan.Status,
	})
}

func getScan(c *gin.Context) {
	id := c.Param("id")
	var scan models.Scan
	if database.DB.First(&scan, id).Error != nil {
		c.JSON(404, gin.H{"error": "Scan not found"})
		return
	}
	
	var findings []models.Finding
	database.DB.Where("scan_id = ?", scan.ID).Find(&findings)
	
	c.JSON(200, gin.H{"scan": scan, "findings": findings})
}

func getScanFindings(c *gin.Context) {
	id := c.Param("id")
	var findings []models.Finding
	database.DB.Where("scan_id = ?", id).Order("created_at desc").Find(&findings)
	c.JSON(200, gin.H{"findings": findings, "count": len(findings)})
}

func listTargets(c *gin.Context) {
	var targets []models.Target
	database.DB.Order("id desc").Find(&targets)
	c.JSON(200, gin.H{"targets": targets, "count": len(targets)})
}

func createTarget(c *gin.Context) {
	var req struct {
		Domain string `json:"domain" binding:"required"`
	}
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(400, gin.H{"error": err.Error()})
		return
	}
	target := models.Target{Domain: req.Domain}
	database.DB.Create(&target)
	c.JSON(201, target)
}

// Add this to the v1 routes section (before the closing brace of v1 group)
// Passive Intelligence
// v1.POST("/passive/recon", handlers.RunPassiveRecon)
